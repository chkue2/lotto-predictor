# 🎯 통합 로또 추천기 V14 (최종판)

📌 **로또 추천기 및 분석 리포트 생성기**

이 프로그램은 1회차부터 최신 회차까지의 로또 데이터를 기반으로  
**마르코프 전이행렬(Markov Transition Matrix)**과 **몬테카를로 시뮬레이션(Monte Carlo Simulation)**을 결합하여  
다양한 형태(균형형 / 집중형 / 혼합형)의 추천 번호를 생성하고,  
패턴 분석 및 시각화 리포트를 제공합니다.

---

## 🚀 주요 특징

- ✅ **전이행렬 + 확률 기반 분석 (Markov Chain)**
- ✅ **Monte Carlo 기반 확률 샘플링**
- ✅ **그룹별 균형형 / 비균형형 조합 생성**
- ✅ **지아넬라 패턴(V7), 원형, 형태학 점수 평가**
- ✅ **혼합형(균형형+자유형) 및 집중형 모드 지원**
- ✅ **중복 없는 상위 10조합 출력**
- ✅ **번호별 빈도/공출현/패턴 시각화 리포트 제공**

---

## ⚙️ 주요 기능 설명

### 1️⃣ 데이터 로딩 및 전처리

- `lotto_data.csv` 파일에서 과거 전체 로또 번호를 불러옵니다.
- `번호1` ~ `번호6` 컬럼을 하나의 리스트(`numbers`)로 병합하여 배열화합니다.
- `numpy` 기반 연산으로 빠른 통계 처리 수행.

### 2️⃣ 전이행렬 기반 분석 (Markov)

- 최근 회차 번호를 기준으로 다음 회차 각 번호의 등장 확률을 계산합니다.
- `build_transition_matrix()`를 통해 45×45 전이행렬을 생성하고,  
  번호 간 관계를 확률적으로 모델링합니다.

### 3️⃣ Monte Carlo 시뮬레이션

- `monte_carlo_vectorized()` 함수가 전이확률 기반으로 3,000~3,500회 샘플링을 수행합니다.
- `focus_mode` 옵션으로 집중형(고확률 중심) / 균형형(확률 분산형) 모드 선택 가능.
- 최근 회차에 등장한 번호는 `apply_recent_draw_penalty()`로 확률이 자동 감쇠됩니다.

### 4️⃣ 그룹 기반 후보 생성

- 번호를 확률순으로 3개 그룹으로 분류:
  G1: 상위 확률 번호 (1~15)
  G2: 중간 확률 번호 (16~30)
  G3: 하위 확률 번호 (31~45)
- 균형형(`use_balance=True`)은 `quota_patterns = [(2,2,2), (3,2,1), (2,3,1)]`을 기반으로  
  그룹별 비율을 유지하여 조합 생성.
- 비균형형(`use_balance=False`)은 전체 번호 풀에서 자유 추출.
- 연속번호(`check_consecutive_rule`)와 대각선(`is_strict_diagonal`) 패턴 제한 적용.

### 5️⃣ 패턴 점수 평가 (Pattern Scoring)

각 조합은 다음 네 가지 패턴 점수를 통해 평가됩니다.

| 패턴 종류         | 함수                            | 설명                             |
| ----------------- | ------------------------------- | -------------------------------- |
| **V7 패턴**       | `gianella_pattern_v7()`         | 행·열 균형, 대각선 분포 점수     |
| **원형 패턴**     | `gianella_pattern_circular()`   | 1~45 구간별 다양성 점수          |
| **형태학 패턴**   | `morphological_pattern_score()` | 연속/대각선 3연속 이상 여부 감점 |
| **대각선 패널티** | `diagonal_penalty_score()`      | 특정 대각 방향 집중 감점         |

➡ `evaluate_patterns_batch()` 함수가 위 점수를 병렬 계산(`ThreadPoolExecutor`)하여  
`v7`, `circ`, `morph`, `diag` 값을 반환합니다.

### 6️⃣ 최종 조합 생성

#### 🟢 균형형 (Balanced)

- `generate_final_combinations_fast(..., ignore_group_balance=False)`  
  → 그룹별 균형 유지하며 상위 10조합 생성.

#### 🔵 비균형형 (Unbalanced)

- `generate_final_combinations_fast(..., ignore_group_balance=True)`  
  → 그룹 제약 해제 후 자유 샘플링 조합 생성.

#### 🟣 혼합형 (Mixed)

- `generate_final_combinations_mixed()`  
  → 균형형 조합 + 자유형 조합을 비율(`free_mode_ratio`)에 맞게 결합.

#### 점수 계산식

total*score = (efficiency * α + pattern*score * β) _ random_factor _ recent_penalty

- 기본 비율:
  - 균형형: α=0.65, β=0.35
  - 집중형: α=0.8, β=0.2
- `recent_penalty_dual()`이 최근 회차 중복번호 패널티 반영.

### 7️⃣ 분석 리포트 및 시각화

- 📊 **번호별 출현 빈도 그래프**
- 🔥 **공출현(Co-occurrence) 행렬 히트맵**
- 📈 **패턴 점수 비교 및 상위 조합 테이블**
- ⏱ **계산 소요 시간 표시**

---

## 🧠 출력 구조 예시

### ✅ 혼합형 추천 10조합 (균형형 + 자유형)

[1, 14, 17, 27, 40, 43] | 효율:0.1518 | V7:53.0 | 원형:55.0 | 형태학:20.0 | 통합:50.6 | 점수:0.4737
...

### 🔥 집중형 추천 10조합 (균형형)

[1, 12, 19, 25, 34, 45] | 효율:0.1846 | V7:54.0 | 원형:55.0 | 형태학:20.0 | 통합:50.5 | 점수:0.3637
...

### 🌟 번호군 균형 제외 추천 10조합 (비균형형)

[4, 13, 19, 24, 31, 39] | 효율:0.1903 | V7:53.0 | 원형:55.0 | 형태학:20.0 | 통합:49.6 | 점수:0.3384
...

- 각 조합은 효율(`eff`), 패턴 점수(`v7`, `circ`, `morph`),  
  통합 점수(`pat`), 최종 점수(`score`)로 구성됩니다.
- 계산 소요 시간 자동 표시.

---

## 📦 설치 및 실행

```bash
pip install -r requirements.txt
streamlit run lotto_predictor_v14.py
```
